server
{

	listen 80;
	server_name 51.250.45.61;

	client_max_body_size 2024m;

	proxy_buffers 16 16k;
	proxy_buffer_size 16k;

	proxy_connect_timeout 300;
	proxy_send_timeout 300;
	proxy_read_timeout 300;
	send_timeout 300;

	location /nginx/
	{
		alias /var/www/error/;
		try_files $uri $uri/ =404;
	}

	error_page 404 /404.html;
	location = /404.html
	{
		root /var/www/error;
		internal;
	}

	error_page 500 /500.html;
	location = /500.html
	{
		root /var/www/error;
		internal;
	}

	error_page 502 /502.html;
	location = /502.html
	{
		root /var/www/error;
		internal;
	}

	error_page 504 /504.html;
	location = /504.html
	{
		root /var/www/error;
		internal;
	}

	location = /.well-known/assetlinks.json {
            alias /var/www/static/google-association-service/assetlinks.json;
    }

    location = /.well-known/apple-app-site-association {
        alias /var/www/static/apple-association-service/assetlinks.json;
#         default_type application/pkcs7-mime;
        default_type application/json;
        add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    }

	# https://rajrajhans.com/2022/06/force-dns-resolution-nginx-proxy/
	# The solution for this problem is to use a variable in the proxy pass directive of nginx,
	# as it forces re-resolution of the DNS name, as nginx treats
	# variables differently to static configuration

	location ^~ /authorizer
	{
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;

		proxy_pass http://authorizer:8080;
	}

	location ~* /authorizer/admin
	{
		proxy_set_header Host $host;
		proxy_pass http://authorizer:8080;
	}

	location ~* /realm([\w-]*)/space([\w-]*)/admin
	{
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_pass http://core:8080;
	}


	location ~* /realm([\w-]*)/space([\w-]*)/api
	{
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_pass http://core:8080;
	}

	location ~* /realm([\w-]*)/api
	{
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_pass http://core:8080;
	}

	location ~* /realm([\w-]*)/workflow
	{
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_pass http://workflow:8080;
	}

	location ~* /realm([\w-]*)/space([\w-]*)/workflow
	{
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_pass http://workflow:8080;
	}

# 	location ~* /realm([\w-]*)/olap
# 	{
# 		proxy_set_header Host $host;
# 		proxy_set_header X-Real-IP $remote_addr;
# 		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
# 		proxy_set_header X-Forwarded-Proto $scheme;
# 		set $app "olap-realm$1";
# 		proxy_pass http://$app.finmars.svc.cluster.local:8080;
# 	}

# 	location ~* /realm([\w-]*)/space([\w-]*)/olap
# 	{
# 		proxy_set_header Host $host;
# 		proxy_set_header X-Real-IP $remote_addr;
# 		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
# 		proxy_set_header X-Forwarded-Proto $scheme;
# 		set $app "olap-realm$1";
# 		proxy_pass http://$app.finmars.svc.cluster.local:8080;
# 	}

	location ~* /realm([\w-]*)/space([\w-]*)/a
	{
		rewrite ^/realm([\w-]*)/space([\w-]*)/a(.*) /$3 break;
		proxy_pass http://portal:8080;

		# kill cache
		add_header Last-Modified $date_gmt;
		add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
		if_modified_since off;
		expires off;
		etag off;
	}

	location ~* ^/realm([\w-]+)/v/_nuxt/(.*)$
	{
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_redirect off;

		# Use the captured group $1 for the dynamic part of the domain
		# Use the captured group $2 for the latter part of the path
		proxy_pass http://vue-portal:8080/realm$1/v/_nuxt/$2;

		# kill cache
		add_header Last-Modified $date_gmt;
		add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
		if_modified_since off;
		expires off;
		etag off;
	}

	location ~* ^/realm([\w-]+)/w/_nuxt/(.*)$
	{
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_redirect off;

		# Use the captured group $1 for the dynamic part of the domain
		# Use the captured group $2 for the latter part of the path
		proxy_pass http://workflow-portal:8080/_nuxt/$2;

		# kill cache
		add_header Last-Modified $date_gmt;
		add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
		if_modified_since off;
		expires off;
		etag off;
	}

	location ~* /realm([\w-]*)/space([\w-]*)/v
	{
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_redirect off;

		proxy_pass http://vue-portal:8080;

		# kill cache
		add_header Last-Modified $date_gmt;
		add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
		if_modified_since off;
		expires off;
		etag off;
	}

    location ~* /realm([\w-]*)/space([\w-]*)/w
    {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect off;

        proxy_pass http://workflow-portal:8080;

        # kill cache
        add_header Last-Modified $date_gmt;
        add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
        if_modified_since off;
        expires off;
        etag off;
    }

# 	location ~* /v/_nuxt/(.*)$
# 	{
# 		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
# 		proxy_set_header Host $http_host;
# 		proxy_redirect off;
# 		set $app "authorizer-portal";

# 		# Use the captured group $1 for the dynamic part of the domain
# 		# Use the captured group $2 for the latter part of the path
# 		proxy_pass http://$app.finmars.svc.cluster.local:8080/_nuxt/$1;

# 		# kill cache
# 		add_header Last-Modified $date_gmt;
# 		add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
# 		if_modified_since off;
# 		expires off;
# 		etag off;
# 	}

	# location ~* /w/_nuxt/(.*)$
    # 	{
    # 		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # 		proxy_set_header Host $http_host;
    # 		proxy_redirect off;

    # 		# Use the captured group $1 for the dynamic part of the domain
    # 		# Use the captured group $2 for the latter part of the path
    # 		proxy_pass http://workflow-portal:8080/_nuxt/$1;

    # 		# kill cache
    # 		add_header Last-Modified $date_gmt;
    # 		add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    # 		if_modified_since off;
    # 		expires off;
    # 		etag off;
    # 	}

# 	location ~* /v
# 	{
# 		set $app "authorizer-portal";

# 		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
# 		proxy_set_header Host $http_host;
# 		proxy_redirect off;

# 		proxy_pass http://$app.finmars.svc.cluster.local:8080;

# 		# kill cache
# 		add_header Last-Modified $date_gmt;
# 		add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
# 		if_modified_since off;
# 		expires off;
# 		etag off;
# 	}

}
